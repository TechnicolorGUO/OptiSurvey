<!DOCTYPE html>
<html lang="">


<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- ===========================
THEME INFO
=========================== -->
<meta name="description" content="">
<meta name="keywords" content="">
<meta name="author" content="">

<!-- ===========================
SITE TITLE
=========================== -->
<title>InteractiveSurvey: An LLM-based Personalized and Interactive Survey Paper Generation System</title>

<!-- ===========================
FAVICONS
=========================== -->
<!--<link rel="icon" href="img/favicon.png">-->
{% load static %}
<!--<link rel="apple-touch-icon" sizes="144x144" href="{% static 'img/apple-touch-icon-ipad-retina.png' %}" />-->
<!--<link rel="apple-touch-icon" sizes="114x114" href="{% static 'img/apple-touch-icon-iphone-retina.png' %}" />-->
<!--<link rel="apple-touch-icon" sizes="72x72" href="{% static 'img/apple-touch-icon-ipad.png' %}" />-->
<!--<link rel="apple-touch-icon" sizes="57x57" href="{% static 'img/apple-touch-icon-iphone.png' %}" />-->

<!-- ===========================
STYLESHEETS
=========================== -->
<script src="https://kit.fontawesome.com/a3d039cc94.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/turndown/7.1.1/turndown.min.js"></script>
<!-- 引入 TinyMCE -->
<script src="https://cdn.tiny.cloud/1/hydxooqdtqqbdmmpz8vzrwogprrvx1q5ctume0t9f2m5bvx2/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>
<link rel="stylesheet" href="{% static 'css/fontawesome-free-5.13.0-web/css/fontawesome.min.css' %}">
<link rel="stylesheet" href="{% static 'css/fontawesome-free-5.13.0-web/css/brands.css' %}">
<link rel="stylesheet" href="{% static 'css/fontawesome-free-5.13.0-web/css/solid.css' %}">
<link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
<link rel="stylesheet" href="{% static 'css/style.css' %}">
<link rel="stylesheet" href="{% static 'css/responsive.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">


<!--<link rel="stylesheet" href= '../../../static/css/fontawesome-free-5.13.0-web/css/fontawesome.min.css'>-->
<!--<link rel="stylesheet" href= '../../../static/css/fontawesome-free-5.13.0-web/css/brands.css'>-->
<!--<link rel="stylesheet" href= '../../../static/css/fontawesome-free-5.13.0-web/css/solid.css'>-->
<!--<link rel="stylesheet" href= '../../../static/css/bootstrap.min.css'>-->
<!--<link rel="stylesheet" href= '../../../static/css/style.css'>-->
<!--<link rel="stylesheet" href= '../../../static/css/responsive.css'>-->

<div id="jsonModal" class="modal">
	<div class="modal-content">
	  <span class="close">&times;</span>
	  <pre id="jsonContent"></pre>
	</div>
</div>

<style>
textarea {
  padding: 0;
}
.pdf-item {
    display: flex;
    align-items: center;
    background: #fff;
    border-radius: 8px;
    padding: 10px;
    margin: 10px 0;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    position: relative;
  }
  .pdf-icon {
    font-size: 2em;
    color: red;
    margin-right: 10px;
  }
  .pdf-details {
    flex-grow: 1;
  }
  .pdf-name {
    font-weight: bold;
    margin: 0;
  }
  .pdf-info {
    font-size: 0.9em;
    color: #666;
    margin: 0;
  }
  .pdf-remove {
    background: none;
    border: none;
    color: red;
    font-size: 1.2em;
    cursor: pointer;
    position: absolute;
    top: 10px;
    right: 10px;
  }
    /* Modal styling */
	.modal {
    display: none;
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgb(0,0,0);
    background-color: rgba(0,0,0,0.4);
    padding-top: 60px;
  }
  .modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
  }
  .close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
  }
  .close:hover,
  .close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
  }
.file {
    position: relative;
    display: inline-block;
    border: 1px solid #99D3F5;
    border-radius: 4px;
    padding: 6px 12px;
    overflow: hidden;

    text-decoration: none;
    text-indent: 0;
    line-height: 20px;
}
.file input {
    position: absolute;
    font-size: 100px;
    right: 0;
    top: 0;
    opacity: 0;
}
.file:hover {
    border-color: #78C3F3;
    color: #004974;
}

.file-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }

.file-item i {
	margin-right: 10px;
	color: red; /* PDF icon color */
}

.popover{
    max-width: 100%; /* Max Width of the popover (depending on the container!) */
}


.form-check-label{
	font-size: 17px;
	color:#B0BCCB;
}

.form-check-label.chatgpt{
	font-size: 17px;
	color: #929BA6;
}

.form-check-input {
    width : 20px;
    height : 20px;
}

/* 一级标题，无缩进 */
#survey_content h1 {
    font-weight: bold !important;
    margin-left: 0; /* 无缩进 */
}

/* 二级标题，少量缩进 */
#survey_content h2 {
    font-weight: bold !important;
    margin-left: 10px; /* 二级标题有少量缩进 */
}

/* 三级标题，更多缩进 */
#survey_content h3 {
    font-weight: bold !important;
    margin-left: 20px; /* 三级标题更多缩进 */
}

/* 四级标题，进一步增加缩进 */
#survey_content h4 {
    font-weight: bold !important;
    margin-left: 30px;
}

/* 五级标题 */
#survey_content h5 {
    font-weight: bold !important;
    margin-left: 40px;
}

/* 六级标题 */
#survey_content h6 {
    font-weight: bold !important;
    margin-left: 50px;
}

/* 正文，跟随最近的标题缩进 */
#survey_content p {
    margin-left: inherit; /* 根据最近的标题继承缩进 */
    text-indent: 2em; /* 文字首行缩进 */
}

.recommendation-container {
	margin-top: 30px;
}

.recommendation-list {
	display: flex;
	overflow-x: auto;
	padding: 10px;
	gap: 20px;
	border: 1px solid #ddd;
	border-radius: 5px;
}

.recommendation-item {
	flex: 0 0 300px;
	border: 1px solid #ddd;
	border-radius: 5px;
	padding: 15px;
	background-color: #f9f9f9;
	box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.recommendation-item h4 {
	font-size: 18px;
	margin-bottom: 10px;
}

.recommendation-item p {
	font-size: 14px;
	color: #555;
	margin-bottom: 10px;
}

.recommendation-item a {
	text-decoration: none;
	color: #007bff;
	font-weight: bold;
}

.recommendation-item a:hover {
	text-decoration: underline;
}

.switch {
    position: relative;
    display: inline-block;
    width: 34px;
    height: 20px;
  }

  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: 0.4s;
    border-radius: 20px;
  }

  .slider:before {
    position: absolute;
    content: "";
    height: 14px;
    width: 14px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.4s;
    border-radius: 50%;
  }

  input:checked + .slider {
    background-color: #4caf50;
  }

  input:checked + .slider:before {
    transform: translateX(14px);
  }
  #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5); /* 半透明背景 */
            color: white;
            font-size: 24px;
            font-weight: bold;
            display: none; /* 初始隐藏 */
            align-items: center;
            justify-content: center;
            z-index: 1000; /* 确保覆盖在最上层 */
        }

  /* PDF预览容器样式 */
  .pdf-container {
    margin: 20px 0;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    background: #fff;
  }

  .pdf-container iframe {
    width: 100%;
    height: 600px;
    border: none;
    display: block;
  }

  #pdf-preview-section {
    margin-top: 40px;
    padding: 20px;
    background: #f9f9f9;
    border-radius: 8px;
  }

  #pdf-preview-section h2 {
    margin-bottom: 20px;
    color: #333;
  }
</style>

<!-- ===========================
FONTS & ICONS
=========================== -->
<!--<link href='http://fonts.googleapis.com/css?family=Kristi|Alegreya+Sans:300' rel='stylesheet' type='text/css'>-->
<!--<link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">-->



<!--[if IE]>
	<script src="https://cdn.jsdelivr.net/html5shiv/3.7.2/html5shiv.min.js"></script>
	<script src="https://cdn.jsdelivr.net/respond/1.4.2/respond.min.js"></script>
	<link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
	<script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
<![endif]-->

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>



<body>
{% block body %}
<div class="container">
	<!-- ===========================
	HEADER
	============================ -->
	<div class="jumbotron">
		<h2 align="center" style="font-size: 3em"> InteractiveSurvey</h2>
		<h3 align="center" style="font-size: 1.5em"> An LLM-based Personalized and Interactive Survey Paper Generation System</h3>
		<!-- <h2 align="right"> --- Automatic Survey Paper Generation</h2> -->
		<br>
		<br>
	</div>
	<hr class="firsthr">


	<!-- ===========================
	HEADER
	============================ -->
	<div class="row">
		<div class="col-md-6">
			<!-- <h2 align="left"> <span class="fas fa-sitemap"></span>  Workflow of the Demo: </h2> -->
				<div align="center">
					<!--<img src="{% static 'img/motivation.gif' %}" style="width:800px;height:450px;", id="workflow_img" >-->
					<img src="{% static '../../../static/img/papers.png' %}" style="width:400px;height:500px;", id="workflow_img" >
				</div>
			<br>
			<br>
		</div>
		<div class="pre-scrollable col-md-6" style="max-height: 500px; width:500px" id="survey_content_example">
			<h1 style="font-size: 1em">A Survey of Predictive Modeling on Imbalanced Data</h1>
			<h2 style="padding: 0px; color: black; font-size: 0.7em">Abstract</h2>
				<p align="justify" style="font-size: 0.5em">The class imbalance problem is encountered in a large number of practical applications of machine learning and data mining, for example, information retrieval and filtering, and the detection of credit card fraud. The imbalanced learning problem is concerned with the performance of learning algorithms in the presence of underrepresented data and severe class distribution skews. Classification of data with imbalanced class distribution has posed a significant drawback of the performance attainable by most standard classifier learning algorithms, which assume a relatively balanced class distribution and equal misclassification costs. In this survey, we conduct a comprehensive overview of predictive modeling on imbalanced data. We classify existing methods into three categories: Training Dataset, Outliers Noise,  and Cost Sensitive.</p>
			<h2 style="padding: 0px; color: black; font-size: 0.7em">Introduction</h2>
				<p align="justify" style="font-size: 0.5em">Class imbalance is a common problem in machine learning (ml ) and data mining (dm ) that occurs when a large number of classes are present in training data (e.g., in medical applications or in the internet of things (iot ) applications ). In this situation, which is found in real world data describing an infrequent but important event, the learning system may have difficulties to learn the concept related to the minority class. Class imbalance has attracted a huge amount of attention from researchers and practitioners in the last decade. However, there are still many fundamental open-ended questions such as are all learning paradigms equally affected by class imbalance? support vector machines (svms ) is a popular machine learning technique that works effectively with balanced datasets. However, when it comes to imbalanced datasets, svms produce suboptimal classification models. The class imbalance problem has attracted growing attention from both academia and industry due to the explosive growth of applications that use and produce imbalanced data. It is important to accurately identify the class of interest but occurs relatively rarely such as cases of fraud, instances of disease, and regions of interest in largescale simulations, it then becomes more costly to misclassify the interesting class.</p>
				<p align="justify" style="font-size: 0.5em">In this paper, we provide a comprehensive review of the state-of-the-art class imbalance learning methods and their evaluation metrics that can be used to evaluate the performance of a learning system in the presence of imbalanced data. In addition, we also provide a detailed analysis of the evaluation metrics used in the evaluation of class imbalanced learning methods in the literature so far. The rest of the paper is organized as follows. In section 2, we introduce the class imbalance problem and its evaluation metrics in section 3. Section 4 presents an overview of the existing evaluation metrics for class imbalance in uci data sets and section 5 presents a comprehensive analysis of their performance in the absence of imbalance in section 6. Section 7 concludes the paper with a discussion of the future research directions in the field of uci learning and evaluation metrics. The remainder of this paper is structured as follows: in section 8 we review the existing class imbalance evaluation metrics and their performance evaluation in the uci domain.
															Section 9 presents a detailed review of their evaluations in section 10. Section 11 presents an analysis of how the current evaluation metrics can be improved in the future and section 12 presents a summary of their future directions in section 13. In section 13 we present a detailed comparison of the performance evaluation metrics of different uci evaluation metrics with respect to their effectiveness in the current uci environment. Section 14 presents a comparison of different evaluation metrics based on their effectiveness and their efficiency in dealing with the imbalanced problem in the present uci scenario.</p>
				<p align="justify" style="font-size: 0.5em">In the following section, we will introduce existing works in each category in detail.</p>
			<h2 style="padding: 0px; color: black; font-size: 0.7em">Methodology</h2>
				<p align="justify" style="font-size: 0.5em">We reviewed existing works and classify them into three types namely: Training Dataset, Outliers Noise,  and Cost Sensitive. The first category is about the training dataset. as a result, the ratio of majority class is decreased significantly, and the final balance training dataset is more suitable for the traditional classification algorithms.  The sencond category is about the outliers noise. therefore, although the existing class imbalance learning (cil) methods can make svms less sensitive to class imbalance, they can still suffer from the problem of outliers and noise.  The third category is about the cost sensitive. in this paper, we develop a cost-sensitive boosting algorithm to improve the classification performance of imbalanced data involving multiple classes.  Empirical tests show that the proposed cost-sensitive boosting algorithm improves the classification performances of imbalanced data sets significantly. </p>
				<h3 style="font-size: 0.6em">Training Dataset</h3>
					<p align="justify" style="font-size: 0.5em">For Training Dataset, there are several existing works. Baccianella, et al. [1] proposes a simple way to turn standard measures for or into ones robust to imbalance.  E.A.P.A. et al. [2] performs a broad experimental evaluation involving ten methods, three of them proposed by the authors, to deal with the class imbalance problem in thirteen uci data sets.  V. et al. [3] implements a wrapper approach that computes the amount of under-sampling and synthetic generation of the minority class examples (smote) to improve minority class accuracy.  Chen, et al. [4] proposes a new feature selection method, feature assessment by sliding thresholds (fast), which is based on the area under a roc curve generated by moving the decision boundary of a single feature classifier with thresholds placed using an even-bin distribution.  Liu, et al. [5] proposes two algorithms to overcome this deficiency.  Song, et al. [6] proposes an improved adaboost algorithm called baboost (balanced adaboost), which gives higher weights to the misclassified examples from the minority class.  Van et al. [7] presents a comprehensive suite of experimentation on the subject of learning from imbalanced data.  an active under-sampling approach is proposed for handling the imbalanced problem in Yang, et al. [8].</p>
				<h3 style="font-size: 0.6em">Outliers Noise</h3>
					<p align="justify" style="font-size: 0.5em">For Outliers Noise, there are several existing works. Batuwita, et al. [9] presents a method to improve fsvms for cil (called fsvm-cil), which can be used to handle the class imbalance problem in the presence of outliers and noise.  Chen, et al. [10] presents ranked minority oversampling in boosting (ramoboost), which is a ramo technique based on the idea of adaptive synthetic data generation in an ensemble learning system.  In classifying documents, the system combines the predictions of the learners by applying evolutionary techniques as well [11]. Ertekin, et al. [12] is concerns with the class imbalance problem which has been known to hinder the learning performance of classification algorithms.  Li, et al. [13] proposes an oversampling method based on support degree in order to guide people to select minority class samples and generate new minority class samples.  J. et al. [14] considers the application of these ensembles to imbalanced data : classification problems where the class proportions are significantly different.  Tao, et al. [15] develops a mechanism to overcome these problems.  C. et al. [16] demonstrates that class probability estimates attained via supervised learning in imbalanced scenarios systematically underestimate the probabilities for minority class instances, despite ostensibly good overall calibration.  Yoon, et al. [17] proposes preprocessing majority instances by partitioning them into clusters.  Zheng, et al. [18] investigates the usefulness of explicit control of that combination within a proposed feature selection framework.</p>	<h3 style="font-size: 0.6em">Cost Sensitive</h3><p align="justify" style="font-size: 0.5em">For Cost Sensitive, there are several existing works. Batista, et al. [19] proposes a simple experimental design to assess the performance of class imbalance treatment methods.  Davis, et al. [20] shows that a deep connection exists between roc space and pr space, such that a curve dominates in roc space if and only if it dominates in pr space.  Drummond, et al. [21] proposes an alternative to roc representation, in which the expected cost of a classi er is represented explicitly.  Ertekin, et al. [22] demonstrates that active learning is capable of solving the problem.  Garcı́a, et al. [23] analyzes a generalization of a new metric to evaluate the classification performance in imbalanced domains, combining some estimate of the overall accuracy with a plain index about how dominant the class with the highest individual accuracy is.  Ghasemi, et al. [24] proposes an active learning algorithm that can work when only samples of one class as well as a set of unlabeled data are available.  He, et al. [25] provides a comprehensive review of the development of research in learning from imbalanced data.  Li, et al. [26] analyzes the intrinsic factors behind this failure and proposes a suitable re-sampling method.  Lin, et al. [27] applies a fuzzy membership to each input point and reformulate the svms such that different input points can make different constributions to the learning of decision surface.  Seiffert, et al. [28] presents a new hybrid sampling/boosting algorithm, called rusboost, for learning from skewed training data.  Sun, et al. [29] develops a cost-sensitive boosting algorithm to improve the classification performance of imbalanced data involving multiple classes.  Torgo et al. [30] presents a generalization of regression error characteristic (rec) curves.  Wasikowski, et al. [31] presents a first systematic comparison of the three types of methods developed for imbalanced data classification problems and of seven feature selection metrics evaluated on small sample data sets from different applications.  Zhou, et al. [32] studies empirically the effect of sampling and threshold-moving in training cost-sensitive neural networks.
			<h2 style="padding: 0px; color: black;font-size: 0.7em">Conclusion</h2>
				<p align="justify" style="font-size: 0.5em">In this survey, we conduct a comprehensive overview of predictive modeling on imbalanced data. We provide a taxonomy which groups the researchs of predictive modeling on imbalanced data into three categories: Training Dataset, Outliers Noise,  and Cost Sensitive.</p>
			<h2 style="padding: 0px; color: black;font-size: 0.7em"> References </h2>
				<p style="color:black; font-size: 0.5em">[1]   Stefano Baccianella, Andrea Esuli, and Fabrizio Sebastiani. 2009. Evaluation measures for ordinal regression. Ninth International Conference on Intelligent Systems Design and Applications, 2009. ISDA'09. IEEE, 283–287.</p>
                <p style="color:black; font-size: 0.5em">[2]   Guilherme Batista, Danilo Silva, and Ronaldo Prati. 2012. An experimental design to evaluate class imbalance treatment methods. 2012 11th International Conference on Machine Learning and Applications (ICMLA), Vol. 2. IEEE, 95–101.</p>
                <p style="color:black; font-size: 0.5em">[3]   Gustavo E.A.P.A. Batista, Ronaldo C. Prati, and Maria Carolina Monard. 2004. A study of the behavior of several methods for balancing machine learning training data. ACM SIGKDD Explor. Newslett. 6, 1 (2004), 20–29.</p>
                <p style="color:black; font-size: 0.5em">[4]   Rukshan Batuwita, and Vasile Palade. 2010. FSVM-CIL: Fuzzy support vector machines for class imbalance learning. IEEE Trans. Fuzzy Syst. 18, 3 (2010), 558–571.</p>
                <p style="color:black; font-size: 0.5em">[5]   Nitesh V. Chawla, Lawrence O. Hall, and Ajay Joshi. 2005. Wrapper-based computation and evaluation of sampling methods for imbalanced datasets. Proceedings of the 1st International Workshop on UtilityBased Data Mining. ACM, New York, NY, 24–33.</p>
                <p style="color:black; font-size: 0.5em">[6]   Sheng Chen, Haibo He, and Edwardo A. Garcia. 2010. Ramoboost: Ranked minority oversampling in boosting. IEEE Trans. Neural Networks 21, 10 (2010), 1624–1642.</p>
                <p style="color:black; font-size: 0.5em">[7]   Xue-wen Chen, and Michael Wasikowski. 2008. Fast: A roc-based feature selection metric for small samples and imbalanced data classification problems. Proceedings of the 14th ACM SIGKDD International Conference on Knowledge Discovery and Data Mining. ACM, New York, NY, 124–132.</p>
                <p style="color:black; font-size: 0.5em">[8]   Jesse Davis, and Mark Goadrich. 2006. The relationship between Precision-Recall and ROC curves. ICML'06: Proc. of the 23rd Int. Conf. on Machine Learning (ACM ICPS). ACM, New York, NY, 233– 240.</p>
                <p style="color:black; font-size: 0.5em">[9]   Marı́a Dolores Del Castillo, and José Ignacio Serrano 2004. A multistrategy approach for digital text categorization from imbalanced documents. ACM SIGKDD Explor. Newslett</p>
                <p style="color:black; font-size: 0.5em">[10]   Chris Drummond, and Robert C. Holte. 2000. Explicitly representing expected cost: An alternative to ROC representation. Proceedings of the Sixth ACM SIGKDD International Conference on Knowledge Discovery and Data Mining. ACM, New York, NY, 198–207.</p>
                <p style="color:black; font-size: 0.5em">[11]   Şeyda Ertekin, Jian Huang, Leon Bottou, and Lee Giles. 2007. Learning on the border: Active learning in imbalanced data classification. Proceedings of the Sixteenth ACM Conference on Conference on Information and Knowledge Management. ACM, New York, NY, 127–136.</p>
                <p style="color:black; font-size: 0.5em">[12]   Şeyda Ertekin, Jian Huang, and C. Lee Giles. 2007. Active learning for class imbalance problem. Proceedings of the 30th Annual International ACM SIGIR Conference on Research and Development in Information Retrieval. ACM, New York, NY, 823–824.</p>
                <p style="color:black; font-size: 0.5em">[13]   Vicente Garcı́a, Ramón Alberto Mollineda, and José Salvador Sánchez 2010. Theoretical analysis of a performance measure for imbalanced data. In 2010 20th International Conference on Pattern Recognition (ICPR)</p>
                <p style="color:black; font-size: 0.5em">[14]   Alireza Ghasemi, Hamid R. Rabiee, Mohsen Fadaee, Mohammad T. Manzuri, and Mohammad H. Rohban. 2011. Active learning from positive and unlabeled data. 2011 IEEE 11th International Conference on Data Mining Workshops (ICDMW). IEEE, 244–250.</p>
                <p style="color:black; font-size: 0.5em">[15]   Haibo He, and Edwardo A. Garcia. 2009. Learning from imbalanced data. IEEE Knowl. Data Eng. 21, 9 (2009), 1263–1284.</p>
                <p style="color:black; font-size: 0.5em">[16]   Kewen Li, Wenrong Zhang, Qinghua Lu, and Xianghua Fang. 2014. An improved SMOTE imbalanced data classification method based on support degree. 2014 International Conference on Identification, Information and Knowledge in the Internet of Things (IIKI). IEEE, 34–38.</p>
                <p style="color:black; font-size: 0.5em">[17]   Peng Li, Pei-Li Qiao, and Yuan-Chao Liu. 2008. A hybrid re-sampling method for SVM learning from imbalanced data sets. Fifth International Conference on Fuzzy Systems and Knowledge Discovery, 2008. FSKD'08. Vol. 2. IEEE, 65–69.</p>
                <p style="color:black; font-size: 0.5em">[18]   Chun-Fu Lin, and Sheng-De Wang. 2002. Fuzzy support vector machines. IEEE Trans. Neur. Network. 13, 2 (2002), 464–471.</p>
                <p style="color:black; font-size: 0.5em">[19]   Xu-Ying Liu, Jianxin Wu, and Zhi-Hua Zhou. 2009. Exploratory undersampling for class-imbalance learning. IEEE Trans. Syst. Man Cybernet. B 39, 2 (2009), 539–550.</p>
                <p style="color:black; font-size: 0.5em">[20]   Juan J. Rodrı́guez, José-Francisco Dı́ez-Pastor, Jesús Maudes, and César Garcı́a-Osorio 2012. Disturbing neighbors ensembles of trees for imbalanced data. In 2012 11th International Conference on Machine Learning and Applications (ICMLA),</p>
                <p style="color:black; font-size: 0.5em">[21]   Chris Seiffert, Taghi M. Khoshgoftaar, Jason Van Hulse, and Amri Napolitano. 2010. RUSBoost: A hybrid approach to alleviating class imbalance. IEEE Trans.Syst. Man Cybernet. A 40, 1 (2010), 185–197.</p>
                <p style="color:black; font-size: 0.5em">[22]   Jie Song, Xiaoling Lu, and Xizhi Wu. 2009. An improved AdaBoost algorithm for unbalanced classification data. Sixth International Conference on Fuzzy Systems and Knowledge Discovery, 2009. FSKD'09. Vol. 1. IEEE, 109–113.</p>
                <p style="color:black; font-size: 0.5em">[23]   Yanmin Sun, Mohamed S. Kamel, and Yang Wang. 2006. Boosting for learning multiple classes with imbalanced class distribution. Sixth International Conference on Data Mining, 2006. ICDM'06. IEEE, 592–602.</p>
                <p style="color:black; font-size: 0.5em">[24]   Dacheng Tao, Xiaoou Tang, Xuelong Li, and Xindong Wu. 2006. Asymmetric bagging and random subspace for support vector machines-based relevance feedback in image retrieval. IEEE Trans. Pattern Anal. Mach. Intell. 28, 7 (2006), 1088–1099.</p>
                <p style="color:black; font-size: 0.5em">[25]   Luı́s Torgo 2005. Regression error characteristic surfaces. In KDD'05: Proc. of the 11th ACM SIGKDD Int. Conf. on Knowledge Discovery and Data Mining. ACM Press,</p>
                <p style="color:black; font-size: 0.5em">[26]   Jason Van Hulse, Taghi M. Khoshgoftaar, and Amri Napolitano. 2007. Experimental perspectives on learning from imbalanced data. Proceedings of the 24th International Conference on Machine Learning. ACM, 935–942.</p>
                <p style="color:black; font-size: 0.5em">[27]   Byron C. Wallace, and Issa J. Dahabreh. 2012. Class probability estimates are unreliable for imbalanced data (and how to fix them). 2012 IEEE 12th International Conference on Data Mining (ICDM). IEEE, 695–704.</p>
                <p style="color:black; font-size: 0.5em">[28]   Mike Wasikowski, and Xue-wen Chen. 2010. Combating the small sample class imbalance problem using feature selection. IEEE Trans. Knowl. Data Eng. 22, 10 (2010), 1388–1400.</p>
                <p style="color:black; font-size: 0.5em">[29]   Zeping Yang, and Daqi Gao. 2012. An active under-sampling approach for imbalanced data classification. 2012 Fifth International Symposium on Computational Intelligence and Design (ISCID). Vol. 2. IEEE, 270–273.</p>
                <p style="color:black; font-size: 0.5em">[30]   Kihoon Yoon, and Stephen Kwek. 2005. An unsupervised learning approach to resolving the data imbalanced issue in supervised learning problems in functional genomics. Fifth International Conference on Hybrid Intelligent Systems, 2005. HIS'05. IEEE, 6–pp.</p>
                <p style="color:black; font-size: 0.5em">[31]   Zhaohui Zheng, Xiaoyun Wu, and Rohini Srihari. 2004. Feature selection for text categorization on imbalanced data. ACM SIGKDD Explor. Newslett. 6, 1 (2004), 80–89.</p>
                <p style="color:black; font-size: 0.5em">[32]   Zhi-Hua Zhou, and Xu-Ying Liu. 2006. Training cost-sensitive neural networks with methods addressing the class imbalance problem. IEEE Trans. Knowl. Data Eng. 18, 1 (2006), 63–77.</p>
		</div>
	</div>
	<hr class="firsthr">

	<!-- ===========================
	CHOOSE TOPICS
	============================ -->
	<div class="col-md-12">
			<div class="row">
				<div id="select_refs">
				<div class="row">
					<div class="col-md-8" style="height: 60px">
						<h2 align="left"><span class="fas fa-tags"></span> Please input the survey topic: </h2>
					</div>
					<!-- <div class="col-md-4" style="height: 60px">
						<button type="button" class="btn btn-danger" id="delete_button" name="delete_button" style="margin-top: 10px; margin-left: 50px; background-color: #dc3545; border-color: #dc3545;" onclick="deleteFiles()">
							<i class="fa fa-trash" aria-hidden="true"></i> Delete All Local References
						</button>
					</div> -->
				</div>
				<br>


				<div class="row">
					<div class="col-md-12">
						<form action="" method="post" id="topic_input" enctype="multipart/form-data">
							{% csrf_token %}
							<!-- Survey ID Dropdown -->
							<!-- <label for="survey-id">Select or Create Survey ID:</label>
							<select id="survey-id" name="survey_id" class="form-control" onchange="handleSurveySelection()">
								<option value="new">Create New Survey ID</option>
							</select> -->
			  
							<!-- Custom Survey ID Input, 默认隐藏，只有选择 "new" 时显示 -->
							<div id="custom-survey-id-container" style="display: none; margin-top: 10px;">
								<input type="text" class="form-control" id="custom-survey-id" name="custom_survey_id" placeholder="Enter new survey ID">
							</div>
							<br>
			  
							<!-- Topic Input (记得添加name属性，便于后端获取) -->
							<input type="text" class="form-control" name="topic" placeholder="Predictive Modeling on Imbalanced Data" id="topic_input_box">
							<br>
							<!-- Recommendation Section -->
							<div id = "recommendation-container" class="recommendation-container" style = "display: none;">
								<div id="recommendation-list" class="recommendation-list">
									<!-- Recommendations will appear here dynamically -->
									Recommendations...
								</div>
								<br>
								<div id="loading-overlay">Downloading PDFs...</div>
								<button id="downloadAllBtn" class="btn btn-primary" onclick="sendPDFLinksToServer()", type="button" >
									Download All PDFs on Server
								</button>
								<br>
							</div>
							<!-- File Upload -->
							<div class="row">
								<div class="col-md-8">
									<div class="file" style="margin-top: 3px;">
										<div id="file_list">
											<span id="file_name">Please Select References from Your Computer...</span>
										</div>
										<input id="file" type="file" name="file" multiple title="Upload your files" onchange="displayFileNames()">
									</div>
								</div>
								<div class="col-md-4">
									<button type="button" class="btn btn-default" onclick="upload_file()" style="margin-top: 0px; margin-left: 150px; margin-bottom: 10px;">
										<i class="fa fa-paperclip" aria-hidden="true"></i>Upload References
									</button>
									<button type="button" class="btn btn-default" onclick="fetchRecommendations()" style="margin-top: 0px; margin-left: 150px;">
										<i class="fa fa-lightbulb" aria-hidden="true"></i>Search References
									</button>
								</div>
							</div>
			  
							<!-- Switch for full PDF mode -->
							<div class="row" style="margin-top: 20px;">
								<div class="col-md-12 text-center">
									<label class="switch">
										<input type="checkbox" id="mode_check_box" onchange="updateMode()">
										<span class="slider round"></span>
									</label>
									<span style="margin-left: 10px;">Enable Full PDF Mode</span>
								</div>
							</div>
						</form>
					</div>
				</div>
			  
				<script>
				  // 当用户选择 'new' 时显示自定义输入框，否则隐藏
				  function handleSurveySelection() {
					const surveySelect = document.getElementById("survey-id");
					const customSurveyContainer = document.getElementById("custom-survey-id-container");
					const selectedValue = surveySelect.value;
					console.log("Selected value:", selectedValue);
					if (selectedValue === "new") {
					  customSurveyContainer.style.display = "block";
					} else {
					  customSurveyContainer.style.display = "none";
					}
				  }
			  
				  // Ajax 加载 survey id 列表并更新下拉框
				  function loadSurveyIDs() {
					fetch('/get_surveys/')
					  .then(response => response.json())
					  .then(data => {
						const surveys = data.surveys;  // 数组，例如 ['test_1', 'test_2']
						const surveySelect = document.getElementById("survey-id");
						
						// 先清空下拉框内容
						surveySelect.innerHTML = "";
						
						// 动态添加已有的 survey id
						surveys.forEach(function(survey) {
						  const option = document.createElement("option");
						  option.value = survey;
						  option.textContent = survey;
						  surveySelect.appendChild(option);
						});
			  
						// 添加 "new" 选项
						const newOption = document.createElement("option");
						newOption.value = "new";
						newOption.textContent = "Create New Survey ID";
						surveySelect.appendChild(newOption);
			  
						// 调用函数判断当前是否需显示输入框
						handleSurveySelection();
					  })
					  .catch(error => console.error("Error fetching surveys:", error));
				  }
			  
				  // 可选方案：提供一个更新按钮，点击时刷新下拉框
				  function updateSurveyIDs() {
					loadSurveyIDs();
				  }
			  
				  // 页面加载时自动获取 survey id 列表
				  document.addEventListener("DOMContentLoaded", function() {
					loadSurveyIDs();
				  });
				</script>
			<br>
	</div>

	
		<script>
			  function updateMode() {
				// 获取开关状态并设置值
				const mode = document.getElementById('mode_check_box').checked ? 'full' : 'intro';
				console.log(`Mode is now: ${mode}`);

				// 通过 jQuery 更新隐藏的 input 值
				$('#mode_check_box').val(mode);
			}

			// 初始化默认值为 "intro"
			document.addEventListener('DOMContentLoaded', function () {
				$('#mode_check_box').val('intro');
			});

			let pdfLinks = [];
			let pdfTitles = [];
			// Function to fetch recommendations from Arxiv API
			async function fetchRecommendations() {
				pdfLinks = [];
				const topic = document.getElementById("topic_input_box").value.trim();
				if (!topic) {
					alert("Please enter a topic!");
					return;
				}

				// Clear previous results
				const recommendationContainer = document.getElementById("recommendation-container");
				recommendationContainer.style.display = "block";

				const recommendationList = document.getElementById("recommendation-list");
				recommendationList.innerHTML = `<p>Loading recommendations...</p>`;

				try {
					// Step 1: Send topic to backend
					const backendResponse = await fetch('/generate_arxiv_query/', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({ topic: topic }),
					});

					if (!backendResponse.ok) {
						// 如果后端返回 error，会抛出异常
						const errorData = await backendResponse.json();
						throw new Error(errorData.error || 'Failed to fetch from backend.');
					}

					// 后端现在直接返回 { "urls": [...], ... }
					const backendData = await backendResponse.json();
					const urls = backendData.urls;

					// 清空 loading
					recommendationList.innerHTML = "";

					// 后端返回类似: { papers: [...], count: 12 }
					const papers = backendData.papers || [];

					if (papers.length === 0) {
						recommendationList.innerHTML = `<p>No recommendations found for "${topic}".</p>`;
						return;
					}

					// 将后端返回的各 paper 渲染到页面
					for (let i = 0; i < papers.length; i++) {
						const { title, summary, pdf_link, arxiv_id } = papers[i];

						const recommendationItem = document.createElement("div");
						recommendationItem.className = "recommendation-item";

						recommendationItem.innerHTML = `
							<h4>${title}</h4>
							<p>${(summary || '').substring(0, 150)}...</p>
							<a href="#" onclick="downloadPDF('${arxiv_id}')">Download PDF</a>
						`;

						recommendationList.appendChild(recommendationItem);

						// 同时将链接推入 pdfLinks
						pdfLinks.push(pdf_link);
						pdfTitles.push(title);
					}
				} catch (error) {
					console.error("Error fetching recommendations:", error);
					recommendationList.innerHTML = `<p>Error fetching recommendations. Please try again later.</p>`;
				}
			}

			function downloadPDFUrl(pdfURL) {
				window.open(pdfURL, '_blank');
			}

			// --- 下载PDF进度条逻辑 ---
			async function sendPDFLinksToServer() {
				if (pdfLinks.length === 0) {
					// alert("No PDFs to download.");
					return;
				}

				// 显示进度条和状态（与上传一致）
				showUploadProgress();

				try {
					const response = await fetch('/download_pdfs/', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({ pdf_links: pdfLinks, pdf_titles: pdfTitles })
					});

					if (!response.ok) {
						hideUploadProgress();
						return;
					}

					const result = await response.json();
					if (result.operation_id) {
						pollDownloadProgress(result.operation_id);
					} else {
						hideUploadProgress();
					}
				} catch (error) {
					hideUploadProgress();
				}
			}

			function pollDownloadProgress(operationId) {
				function checkProgress() {
					$.ajax({
						type: "GET",
						url: "/get_operation_progress/",
						data: { operation_id: operationId },
						success: function(result) {
							const progress = result.progress || 0;
							const message = result.message || 'Processing...';
							const status = result.status || 'running';

							updateProgressBar(progress, message);

							if (status === 'completed') {
								setTimeout(() => {
									hideUploadProgress();
									// 可选：可在此处添加下载完成后的提示或刷新
								}, 500);
							} else if (status === 'failed') {
								hideUploadProgress();
								// 可选：可在此处添加失败提示
							} else {
								setTimeout(checkProgress, 2000);
							}
						},
						error: function(jqXHR, textStatus, errorThrown) {
							setTimeout(checkProgress, 5000);
						}
					});
				}
				checkProgress();
			}

			// 处理下载结果
			function handleDownloadResult(result) {
				// 构建结果消息
				let message = result.message;
				if (result.failed && result.failed.length > 0) {
					message += `\n\nFailed downloads (${result.failed.length}):\n`;
					result.failed.forEach(failed => {
						message += `- ${failed.url}: ${failed.reason}\n`;
					});
				}
				
				alert(message);
			}
		</script>

	<!-- ===========================
     References
    ============================ -->
	<div class="col-md-12" style="display: none" id="refs">
		<div class="alert alert-success alert-dismissable" style="height: 100px">
			<button type="button" class="close" data-dismiss="alert"
					aria-hidden="true">
				&times;
			</button>
			<h4 align="center">Great! You have finished uploading the reference papers!</h4>
			<br>
			<h4 align="center">Let's categorize the reference papers for organizing our survey!</h4>
		</div>


		<h2 align="left" id="refs_head"> <span class="fas fa-copy"></span> Here are the most related references from our dataset: </h2>
		<form action="" method="post", id="ref_form">
			{% csrf_token %}
			<div class="list-group pre-scrollable" id="ref_list" style="height:800px">
			</div>

			<!-- <p align="right"> *(Selected references for instant survey generation)</p> -->


			<div class="col-md-12" style="text-align: center; display: none; align-items: center; justify-content: center;" id="auto_taxonomy">
				<!-- 分类标准输入框 -->
				<input placeholder="Please input your categorization standard and determine the number of clusters" class="form-control" id="taxonomy_standard" name="taxonomy_standard">
				<br>
				<!-- 选择 Global_cluster_num -->
				<select class="form-control" id="cluster_num_select" name="Global_cluster_num" style="width: 100px; margin-right: 10px; display: none;">
					<option value="2">2</option>
					<option value="3" selected>3</option>
					<option value="4">4</option>
					<option value="5">5</option>
					<option value="6">6</option>
				</select>
			
				<!-- 触发 AJAX 的按钮 -->
				<div class="text-center">
				  <input type="button" class="btn btn-default" onclick="display_taxonomy()" value="Personalized Reference Categorization">
				</div>
		</form>





	</div>
	<hr class="firsthr">
	<!-- ===========================
     Taxonomy Result
    ============================ -->
	<div class="col-md-12" style="display: none" id="taxonomy">

		<h2 align="left"> <span class="fas fa-chart-pie"></span> The Categorization result of references based on the input criteria. </h2>

		<div class="row">
			<div class="col-md-7" style="height:400px;">
				<img src="#" style="width:400px;height:400px;", id="tsne_img">
			</div>
			<div class="col-md-5" style="height:400px;">
					<p>  </p>
					<ul id="legend" style="position: relative;top: 30%;transform: translateY(-30%);">
					</ul>
			</div>
		</div>
		<br>
		<div class="alert alert-info alert-dismissable" style="height: 100px">
			<button type="button" class="close" data-dismiss="alert"
					aria-hidden="true">
				&times;
			</button>
			<h4 align="center">We have finished the reference categorization.</h4>
			<br>
			<h4 align="center">Not satisfied with the results? You can modify it by yourself!</h4>
		</div>
		<br>
		<div class="row" id="modify_taxonomy">

		</div>
		<hr class="firsthr">
	</div>

	<div class="col-md-12" style="display: none" id="generate_content_button">
		<input type="button" class="btn btn-default" onclick="confirm_display_select_sections()" value="Confirm and Display Outline" style="width: 300px; margin-left:35%">
	</div>


	<!-- ===========================
     Select Sections
    ============================ -->
	<div class="col-md-12" style="display: none" id="sections">
		<br>

		<div class="alert alert-info alert-dismissable" style="height: 100px">
			<button type="button" class="close" data-dismiss="alert"
					aria-hidden="true">
				&times;
			</button>
			<h4 align="center">The categorization result is saved!</h4>
			<br>
			<!-- <h4 align="center">Our model will learn from your modification! </h4> -->
		</div>


		<h2 align="left"> The outline of the survey paper to be generated: </h2>
		<form action="" method="post", id="sections_">
			{% csrf_token %}
		</form>
	


		<br>
		<div style="text-align: center">
			<input type="button" class="btn btn-default" onclick="display_survey()" value="Generate Survey">
		</div>
	</div>

	<!-- ===========================
     Content Modification
    ============================ -->
	<div class="col-md-12" style="display: none" id="modification">
		<!-- <br>
		<div class="alert alert-info alert-dismissable" style="height: 100px">
			<button type="button" class="close" data-dismiss="alert"
					aria-hidden="true">
				&times;
			</button>
			<h4 align="center">This is the survey content draft generated by our model(and Polished by ChatGPT).</h4>
			<br>
			<h4 align="center">If you are not satisfied, you can revise it.</h4>
		</div>


		<form action="" method="post", id="content_modify">
			{% csrf_token %}
		</form>
		<br>
		<div style="text-align: center">
			<input type="button" class="btn btn-default" onclick="display_survey()" value="Confirm">
		</div> -->
	</div>


	<!-- ===========================
     Generated survey
    ============================ -->
	<div class="col-md-12" style="display: none" id="survey">
		<br>
		<div class="alert alert-info alert-dismissable" style="height: 100px">
			<button type="button" class="close" data-dismiss="alert"
					aria-hidden="true">
				&times;
			</button>
			<h4 align="center">You have finished all the steps!</h4>
			<br>
			<h4 align="center">Here is the generated survey paper!</h4>
		</div>
		<h2 align="left"> <span class="fas fa-scroll"></span> Here is the generated survey content: </h2>
		<div class="row">
			<div class="col-md-0"></div>
			<div class="col-md-12">
				<button id="downloadBtn" type="button" class="btn btn-info" title="Download as Markdown"
				style="float: right;">
					Download as PDF (with references)
				</button>
				<br><br>
				<button id="finalDownloadBtn" type="button" class="btn btn-info" title="Download as LaTeX" 
				style="float: right;" disabled>
					Download as PDF (LaTeX)
				</button>
				<br><br>
				<button id="editBtn" type="button" class="btn btn-info" title="Edit Content"
				style="float: right;">
					Edit the content
				</button>
				<button id="saveBtn" type="button" class="btn btn-info" title="Edit Content"
				style="float: right; display:none;">
					Save
				</button>
			</div>
		</div>
		<div class="container pre-scrollable col-md-12" style="max-height: 700px" id="survey_content">
		</div>
	</div>
	<script>
		// 第一个按钮一旦被点击，就解禁第二个按钮
		const downloadBtn = document.getElementById('downloadBtn');
		const finalDownloadBtn = document.getElementById('finalDownloadBtn');
	
		downloadBtn.addEventListener('click', () => {
			finalDownloadBtn.disabled = false;
		});
	</script>

	<div class="col-md-12" style="display: none" id="references"></div>

	<!-- ===========================
     PDF Preview Section
    ============================ -->
	<div class="col-md-12" style="display: none" id="pdf-preview-section">
		<hr class="firsthr">
		<h2 align="left"><span class="fas fa-file-pdf"></span> PDF Preview</h2>
		<div class="text-right mb-2">
			<a id="pdf-download-link" href="" download class="btn btn-primary btn-sm" style="display: none;">
				<i class="fas fa-download"></i> Download PDF
			</a>
		</div>
		<div class="pdf-container" id="pdf-preview-container">
			<iframe id="pdf-preview-frame" src="" style="width: 100%; height: 600px; border: 1px solid #ddd;"></iframe>
		</div>
	</div>


</div><!--container end-->





<!-- =========================== Script ============================ -->


<!--necessary scripts and plugins-->
{% load static %}
<!--<script src="{% static 'scripts/jquery-1.8.3.min.js' %}"></script>-->
<script src="http://code.jquery.com/jquery-1.9.1.js"></script>
<script src="{% static 'scripts/bootstrap.min.js' %}"></script>
<script src="{% static 'scripts/jquery.nicescroll.min.js' %}"></script>
<script src="{% static 'scripts/evenfly.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
{% block script %}
<script>
	function deleteFiles() {
		$.ajax({
			url: '/delete_files/',
			type: 'POST',
			headers: {
				'X-CSRFToken': getCookie('csrftoken')
			},
			success: function(data) {
				if (data.success) {
					alert("Delete successfully.");
				} else {
					alert("Delete failed.");
				}
			},
			error: function(xhr, status, error) {
				console.error('Error:', error);
			}
		});
	}

	function getCookie(name) {
		let cookieValue = null;
		if (document.cookie && document.cookie !== '') {
			const cookies = document.cookie.split(';');
			for (let i = 0; i < cookies.length; i++) {
				const cookie = cookies[i].trim();
				if (cookie.substring(0, name.length + 1) === (name + '=')) {
					cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
					break;
				}
			}
		}
		return cookieValue;
	}

	var topic = ""

    function handleFiles(event) {
        if (!event || !event.target || !event.target.files) {
            console.error('Invalid event');
            return;
        }

        const files = event.target.files;
        let fileNames = [];
        for (let i = 0; i < files.length; i++) {
            let filePath = files[i].name.split('\\');
            let fileName = filePath[filePath.length - 1];
            fileNames.push(fileName);
        }
        document.getElementById("file_name").innerHTML = fileNames.join(', ');
    }


	// Get the modal
	var modal = document.getElementById("jsonModal");

	// Get the <span> element that closes the modal
	var span = document.getElementsByClassName("close")[0];

	// When the user clicks on <span> (x), close the modal
	span.onclick = function() {
		modal.style.display = "none";
	}

	// When the user clicks anywhere outside of the modal, close it
	window.onclick = function(event) {
		if (event.target == modal) {
			modal.style.display = "none";
		}
	}


	// function sanitizeFilename(filename) {
	// 	let title_new = filename.trim();
	// 	let invalid_chars = ['<', '>', ':', '"', '/', '\\', '|', '?', '*','_'];
	// 	for (let char of invalid_chars) {
	// 		title_new = title_new.replace(new RegExp(`\\${char}`, 'g'), ' ');
	// 	}
	// 	return title_new;
	// }

	function displayFileNames() {
		const input = document.getElementById('file');
		const fileList = document.getElementById('file_list');
		fileList.innerHTML = ''; // Clear previous file names

		for (let i = 0; i < input.files.length; i++) {
			const file = input.files[i];
			const fileItem = document.createElement('div');
			fileItem.className = 'file-item';
			fileItem.innerHTML = `
				<i class="fas fa-file-pdf"></i> ${file.name}
			`;
			fileList.appendChild(fileItem);
		}
	}

	function sanitizeFilename(filename) {
    var lastDot = filename.lastIndexOf('.');
    
    // Helper function to sanitize parts with spaces and capitalize first word
    function sanitizePart(part) {
        // Replace non-alphanumerics with space, collapse multiple spaces, and trim
        part = part
            .toLowerCase()
            .replace(/[^a-z0-9]/g, ' ')
            .replace(/\s+/g, ' ')
            .trim();
        
        // Split into words
        var words = part.split(' ');
        
        if (words.length === 0) return '';
        
        // Capitalize the first word
        words[0] = words[0].charAt(0).toUpperCase() + words[0].slice(1);
        
        // Rejoin with spaces
        return words.join(' ');
    }
    
    if (lastDot === -1) {
        // No extension
        return sanitizePart(filename);
    } else if (lastDot === 0) {
        // Hidden file (e.g., .bashrc)
        var extension = filename.substring(1);
        return '.' + sanitizePart(extension);
    } else {
        // File with extension
        var name = filename.substring(0, lastDot);
        var extension = filename.substring(lastDot + 1);
        return sanitizePart(name) + '.' + sanitizePart(extension);
    }
}

    function upload_file(){
    	/*
    	const ref_list = []
    	const fileList = document.getElementById("file").files; // now you can work with the file list
  		for (let i = 0, numFiles = fileList.length; i < numFiles; i++) {
  			ref_list.push(fileList[i].name);
  		}
  		*/

		var formData = new FormData();
		var files = document.getElementById("file").files;
        for (var i = 0; i < files.length; i++) {
            formData.append("file" + i, files[i]);
        }
		topic = $('#topic_input_box').val()
		mode = $('#mode_check_box').val()
		survey_id = $('#survey-id').val()
		custom_survey_id = $('#custom-survey-id').val()
		formData.append("topic", topic);
		formData.append("mode", mode);
		formData.append("survey_id", survey_id);
		formData.append("custom_survey_id", custom_survey_id);

		// 显示进度条和状态信息
		showUploadProgress();

		$.ajax({
		type: "POST",
		dataType: "json",
		url: "/upload_refs",
		processData: false,
		contentType: false,
		data: formData,
		success: function(result) {
			if (result.operation_id) {
				// 异步任务已启动，开始轮询进度
				pollUploadProgress(result.operation_id);
			} else {
				// 兼容旧版本的同步响应
				handleUploadSuccess(result);
			}
		},
		error: function(jqXHR, textStatus, errorThrown){
			hideUploadProgress();
			alert("Upload failed: " + jqXHR.responseText);
		}
		});
	}

	function showUploadProgress() {
		// 显示进度条（如果没有，创建一个简单的）
		if (!$('#upload-progress').length) {
			$('body').append(`
				<div id="upload-progress" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
					 background: white; padding: 20px; border: 2px solid #ccc; border-radius: 10px; z-index: 9999; min-width: 300px;">
					<div style="text-align: center;">
						<h4>Uploading Files...</h4>
						<div id="progress-bar" style="width: 100%; background-color: #f0f0f0; border-radius: 5px; margin: 10px 0;">
							<div id="progress-fill" style="width: 0%; height: 20px; background-color: #4CAF50; border-radius: 5px; transition: width 0.3s;"></div>
						</div>
						<div id="progress-text">Starting upload...</div>
						<div id="progress-percentage">0%</div>
					</div>
				</div>
			`);
		}
		$('#upload-progress').show();
	}

	function hideUploadProgress() {
		$('#upload-progress').hide();
	}

	function updateProgressBar(progress, message) {
		$('#progress-fill').css('width', progress + '%');
		$('#progress-text').text(message);
		$('#progress-percentage').text(progress + '%');
	}

	function pollUploadProgress(operationId) {
		function checkProgress() {
			$.ajax({
				type: "GET",
				url: "/get_operation_progress/",
				data: { operation_id: operationId },
				success: function(result) {
					const progress = result.progress || 0;
					const message = result.message || 'Processing...';
					const status = result.status || 'running';

					updateProgressBar(progress, message);

					if (status === 'completed') {
						// 任务完成
						setTimeout(() => {
							hideUploadProgress();
							if (result.result) {
								handleUploadSuccess(result.result);
							} else {
								handleUploadSuccess(result);
							}
						}, 500);
					} else if (status === 'failed') {
						// 任务失败
						hideUploadProgress();
						alert('Upload failed: ' + (result.error || 'Unknown error'));
					} else {
						// 继续轮询
						setTimeout(checkProgress, 2000); // 每2秒检查一次
					}
				},
				error: function(jqXHR, textStatus, errorThrown) {
					console.error('Progress check failed:', textStatus, errorThrown);
					// 继续尝试，但增加间隔
					setTimeout(checkProgress, 5000);
				}
			});
		}

		// 开始轮询
		checkProgress();
	}

	function handleUploadSuccess(result) {
		// 重置PDF预览区域（因为这是新的survey）
		document.getElementById('pdf-preview-section').style.display = 'none';
		document.getElementById('pdf-preview-frame').src = '';
		document.getElementById('pdf-download-link').style.display = 'none';
		document.getElementById('pdf-download-link').href = '';
		
		// 原来的成功处理逻辑
		// Iterate over the filenames array
		for (let i = 0, len = result['filenames'].length; i < len; i++) {
		let filename = result['filenames'][i];
		let filesize = result['filesizes'][i];
		let sanitizedFilename = sanitizeFilename(filename);
		let survey_id = result['survey_id'];
		let ref_id = result['ref_ids'][i];
		// let parts = filename.split(' ');
		// parts.pop();
		// let cleanedFileName = parts.join(' ');
		let cleanedFileName = filename;

		// Create HTML structure for PDF icon with clickable link
		let pdfHtml = `
		<div class="pdf-item" style="display: flex; align-items: center; font-size: 0.8em;">
			<div class="pdf-icon" style="flex-shrink: 0;">
				<i class="fas fa-file-pdf"></i>
			</div>
			<div class="pdf-details" style="flex-grow: 1; margin-left: 10px;">
				<a href="#" onclick="fetchAndDisplayJson('/static/data/txt/${survey_id}/${sanitizedFilename}.json'); return false;">
					<p class="pdf-name" style="margin: 0; font-size: 1em;">${sanitizedFilename}</p>
					<p class="pdf-info" style="margin: 0; font-size: 0.9em;">${filesize} MB</p>
				</a>
			</div>

			<input type="hidden" name="refs" value="${ref_id}" class="pdf-hidden-input">
		</div>
	`;
		$("#ref_list").append(pdfHtml);
		}
		$("#refs").attr("style","display:inline;");
		$("#select_refs").attr("style","display:none;");
		$("#input_ref_head").html("<span class=\"fas fa-tags\"></span> You can input topic by yourself:");
		$("#refs_head").html("<span class=\"fas fa-copy\"></span> Here are the uploaded references:");
		$("#auto_taxonomy").attr("style","display:inline;");
	}

	function removePdf(element) {
		element.parentElement.remove();
		}


	function fetchAndDisplayJson(path) {
		$.ajax({
			type: "GET",
			url: path,
			dataType: "json",
			success: function(data) {
				// Remove 'title' and 'introduction' fields
				const filteredData = Object.fromEntries(
					Object.entries(data).filter(
						([key]) => key !== 'title' && key !== 'introduction'
					)
				);
				let jsonContent = JSON.stringify(filteredData, null, 2);
				document.getElementById("jsonContent").textContent = jsonContent;
				document.getElementById("jsonModal").style.display = "block";
			},
			error: function(jqXHR, textStatus, errorThrown) {
				alert("Failed to load JSON data: " + errorThrown);
			}
		});
	}

    function sub_topic(){
    	//alert($('#topic_form').serialize());
		$.ajax({
			type: "POST",
			dataType: "json",
			url: "/get_topic",
			data: $('#topic_form').serialize(),

			success: function(result) {
				// alert(result);
				for (let i = 0, len = result['references'].length; i < len; i++) {
				// for (const v of result['references']) {
					document.getElementById("ref_list").innerHTML += "<div class=\"input-group\"><span class=\"input-group-addon\"><input name=\"refs\" type=\"checkbox\" value="+result['ref_ids'][i] + " checked></span><a href=" + result['ref_links'][i]+ " target=\"_blank\" class=\"list-group-item\">" + result['references'][i] + "</a></div>";
				}
				$("#refs").attr("style","display:inline;");
				$("#input_ref").attr("style","display:none;");
			},
			error: function(jqXHR, textStatus, errorThrown){
				alert(jqXHR.responseText);
				/*
				alert(jqXHR.status);
				alert(jqXHR.readyState);
				alert(jqXHR.statusText);
				alert(textStatus);
				alert(errorThrown);
				*/
			}
		});
	}

	function formToJson (data) {
    	data=data.replace(/&/g,"\",\"");
    	data=data.replace(/=/g,"\":\"");
    	data="{\""+data+"\"}";
    	return data;
	}
	function display_taxonomy(){
    // 获取用户选择的 Global_cluster_num
    const clusterNum = document.getElementById("cluster_num_select").value;
    const taxonomyStandard = $('#taxonomy_standard').val();
    let refs = [];
    $('#ref_list .pdf-hidden-input').each(function() {
        refs.push($(this).val());
    });

    // 使用 FormData 构建 POST 数据
    const formData = new FormData();
    formData.append("refs", JSON.stringify(refs));
    formData.append("taxonomy_standard", taxonomyStandard);
    formData.append("Global_cluster_num", clusterNum);

    // 显示进度条和状态信息（与上传一致）
    showUploadProgress();

    $.ajax({
        type: "POST",
        dataType: "json",
        url: "/automatic_taxonomy",
        processData: false,
        contentType: false,
        data: formData,
        success: function(result) {
            if (result.operation_id) {
                // 异步任务已启动，开始轮询进度
                pollTaxonomyProgress(result.operation_id);
            } else {
                // 兼容旧版本的同步响应
                hideUploadProgress();
                handleTaxonomySuccess(result);
            }
        },
        error: function(jqXHR, textStatus, errorThrown){
            hideUploadProgress();
            alert("Categorization failed: " + jqXHR.responseText);
        }
    });
}

function pollTaxonomyProgress(operationId) {
    function checkProgress() {
        $.ajax({
            type: "GET",
            url: "/get_operation_progress/",
            data: { operation_id: operationId },
            success: function(result) {
                const progress = result.progress || 0;
                const message = result.message || 'Processing...';
                const status = result.status || 'running';

                updateProgressBar(progress, message);

                if (status === 'completed') {
                    setTimeout(() => {
                        hideUploadProgress();
                        if (result.result) {
                            handleTaxonomySuccess(result.result);
                        } else {
                            handleTaxonomySuccess(result);
                        }
                    }, 500);
                } else if (status === 'failed') {
                    hideUploadProgress();
                    alert('Categorization failed: ' + (result.error || 'Unknown error'));
                } else {
                    setTimeout(checkProgress, 2000);
                }
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.error('Progress check failed:', textStatus, errorThrown);
                setTimeout(checkProgress, 5000);
            }
        });
    }
    checkProgress();
}

function handleTaxonomySuccess(result) {
    // 原有的分类结果渲染逻辑
    document.getElementById("legend").innerHTML += "<h2>" + $("#taxonomy_standard").val() + "</h2>";
    for (let i = 0, len = result['colors'].length; i < len; i++) {
        document.getElementById("legend").innerHTML += "<li class=\"list-group-item\" style=\"color: " + result['colors'][i] + "\">" + result['category_label'][i] + " </li>";
    }
    var addr = "static/img/tsne_" + result['survey_id'] + ".png";
    $("#tsne_img").attr("src", addr);
    document.getElementById("modify_taxonomy").innerHTML += "<h2> You can also modify the categorization result: </h2>";
    for (let i = 0, len = result['category_label'].length; i < len; i++) {
        document.getElementById("modify_taxonomy").innerHTML +=
            `<div class="panel panel-primary">
                <div class="panel-heading" style="background-image: none; background-color:${result['colors'][i]}">
                    <h3 class="panel-title">${result['category_label'][i]}</h3>
                </div>
                <div class="panel-body" id="${result['category_label'][i]}"></div>
            </div>`;
        for (let j = 0, len = result['ref_indexs'][i].length; j < len; j++) {
            document.getElementById(result['category_label'][i]).innerHTML +=
                `<div class="input-group" id="ref_${result['ref_indexs'][i][j]}">
                    <span class="input-group-addon">[${result['ref_indexs'][i][j]}]</span>
                    <a href="0" target="_blank" class="list-group-item">${result['ref_titles'][i][j]}</a>
                    <span class="input-group-addon">
                        <div class="btn-group">
                            <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Change to <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu" id="ref_${result['ref_indexs'][i][j]}_change">`;
            for (let k = 0, len = result['category_label'].length; k < len; k++) {
                if (result['category_label'][i] != result['category_label'][k]) {
                    document.getElementById(`ref_${result['ref_indexs'][i][j]}_change`).innerHTML +=
                        `<li><a onclick="change_taxonomy('${result['category_label'][i]}', 'ref_${result['ref_indexs'][i][j]}', '${result['category_label'][k]}')">${result['category_label'][k]}</a></li>`;
                }
            }
            document.getElementById(result['category_label'][i]).innerHTML +=
                `</ul>
                        </div>
                    </span>
                </div>`;
        }
    }
    $("#taxonomy").attr("style", "display:inline;");
    $("#generate_content_button").attr("style", "display:inline; align: center;");
}


	function change_taxonomy(source_taxonomy, ref_id, target_taxonomy) {
        console.log(source_taxonomy);
        console.log(ref_id);
        console.log(target_taxonomy);
		// remove this item from source_taxonomy
        var Element = document.getElementById(ref_id);
        console.log(Element);
        var old_ul = document.getElementById(ref_id+'_change');
        var ul_length = old_ul.children.length;

        old_ul.parentNode.removeChild(old_ul);
        Element.parentNode.removeChild(Element);

        // edit the element
		var new_ul = document.createElement('ul');
		$(new_ul).attr('class', 'dropdown-menu');
		$(new_ul).attr('id', ref_id+'_change');
		for (var i = 0; i < ul_length; i ++) {
            var li=document.createElement("li");
            if (target_taxonomy == old_ul.children[i].textContent) {
                var attr_ = "<a onclick=\'change_taxonomy(\""
									+ target_taxonomy
									+ "\" , \""
									+ ref_id
									+ "\", \""
									+ source_taxonomy
									+ "\")\'>"
									+ source_taxonomy
									+ "</a>";
            } else {
                var attr_ = "<a onclick=\'change_taxonomy(\""
                    + target_taxonomy
                    + "\" , \""
                    + ref_id
                    + "\", \""
                    + old_ul.children[i].textContent
                    + "\")\'>"
                    + old_ul.children[i].textContent
                    + "</a>";
			}
            $(attr_).appendTo(li);
            $(li).appendTo(new_ul);
		}
		$(new_ul).appendTo(Element.children[2].children[0]);
        // add this item to target_taxonomy
        var target = document.getElementById(target_taxonomy);
        // console.log(target.innerHTML);
        target.appendChild(Element);
    }


	function generate_updated_cate_list() {
    // 初始化结果格式
    var updated_cate_list = {
        'colors': [],
        'category_label': [],
        'ref_titles': [],
        'ref_indexs': []
    };

    // 遍历所有分类面板
    $(".panel").each(function() {
        // 获取当前分类名和颜色
        var category_label = $(this).find(".panel-title").text();
        var color = $(this).find(".panel-heading").css("background-color");

        // 初始化分类的条目和索引
        var titles = [];
        var indices = [];

        // 遍历分类下的条目
        $(this).find(".input-group").each(function() {
            var ref_title = $(this).find("a").text(); // 获取条目标题
            var ref_index = $(this).find(".input-group-addon").first().text().replace("[", "").replace("]", ""); // 获取条目索引

            titles.push(ref_title); // 添加标题
            indices.push(parseInt(ref_index)); // 添加索引（转为整数）
        });

        // 将分类信息添加到结果中
        updated_cate_list['colors'].push(color);
        updated_cate_list['category_label'].push(category_label);
        updated_cate_list['ref_titles'].push(titles);
        updated_cate_list['ref_indexs'].push(indices);
    });

    return updated_cate_list;
}



	function change_clustering() {
		var current_cate_list = generate_updated_cate_list();
		$.ajax({
			type: "POST",
			url: "/save_updated_cluster_info", // 后端处理保存的接口
			data: JSON.stringify({
				updated_cate_list: current_cate_list
			}),
			contentType: "application/json",
			success: function(response) {
				alert("Updated cluster info saved successfully!");
			},
			error: function(jqXHR, textStatus, errorThrown) {
				alert("Failed to save updated cluster info: " + jqXHR.responseText);
			}
		});
	}


	function confirm_display_select_sections() {
		change_clustering()
		// submit revised taxonomy to backend
        let topic_word_list = [];
		let ref_lists = [];
		div_elements = document.getElementById('taxonomy').getElementsByTagName('*');
		for (i=0;i<div_elements.length;i++){
			if(div_elements[i].className == "panel-body") {
				topic_word_list.push(div_elements[i].id);
				tmp_list = []
				refs = div_elements[i].getElementsByTagName('*');
				for (j=0;j<refs.length;j++) {
					if(refs[j].className == "input-group") {
						tmp_list.push(refs[j].id.split('_')[1])
					}
				}
				ref_lists.push(tmp_list)
			}
		}
		// add a button

		//New: Generate the outline
		

		$.ajax({
			type: "POST",
			dataType: "json",
			url: "/annotate_categories",
			data: {
				'topic_word_list': topic_word_list,
				'ref_lists': ref_lists
			},
			success: function(result) {
				if (result.html) {
					// 将返回的 HTML 内容插入到 form 中
					$('#sections_').html(result.html);
				} else if (result.error) {
					// 处理错误信息
					alert(result.error);
				}
			},
			error: function(jqXHR, textStatus, errorThrown) {
				alert(jqXHR.responseText);
			}
		});
		$("#sections").attr("style","display:inline;");


	}



function select_sections() {
    var section_list = {};

    if($('#cbx_abstract').is(":checked")) {section_list['abstract'] = 1}

    if($('#cbx_introduction').is(":checked")) {section_list['introduction'] = 1}

    if($('#cbx_background').is(":checked")) {section_list['background'] = 1}

    if($('#cbx_method').is(":checked")) {section_list['method'] = 1}

    if($('#cbx_reminder').is(":checked")) {section_list['reminder'] = 1}

    if($('#cbx_c_and_c').is(":checked")) {section_list['c_and_c'] = 1}

    if($('#cbx_evaluation').is(":checked")) {section_list['evaluation'] = 1}

    if($('#cbx_app').is(":checked")) {section_list['app'] = 1}

    if($('#cbx_clg').is(":checked")) {section_list['clg'] = 1}

    if($('#cbx_methodology').is(":checked")) {section_list['methodology'] = 1}

    if($('#cbx_conclusion').is(":checked")) {section_list['conclusion'] = 1}


    $.ajax({
        type: "POST",
        dataType: "json",
        url: "/select_sections",
        data: section_list,
        success: function(result) {
            for(var p in result) {
                if (p == "title") {
                    document.getElementById("content_modify").innerHTML+= "<h2 style=\"padding: 0px; color: black\"> Title </h2>";
                    document.getElementById("content_modify").innerHTML+= "<p id=section_" + p + " class=\"form-control\">"  + "A Survey of " +document.getElementById("topic_input_box").value + "</p>";
                }
            }

            for(var p in result) {
                if (p == "abstract") {
                    document.getElementById("content_modify").innerHTML+= "<h2 style=\"padding: 0px; color: black\"> Abstract </h2>";
                    document.getElementById("content_modify").innerHTML+= "<textarea id=section_" + p + " class=\"form-control\" rows = \" 10 \">" + result[p][0] + " " + result[p][1] + "</textarea>";

                }
            }

            for(var p in result) {
                if (p == "introduction") {
                    document.getElementById("content_modify").innerHTML+= "<h2 style=\"padding: 0px; color: black\"> Introduction </h2>";

                    document.getElementById("content_modify").innerHTML+= "<h3 style=\"padding: 0px; color: black\">" + result[p][0]["subtitle"]+ "</h3>";
                    document.getElementById("content_modify").innerHTML+= "<textarea name=\"intro_sub_content\" class=\"form-control\" rows = \" 30 \">" + result[p][0]["content"] + "</textarea><p>";

                    document.getElementById("content_modify").innerHTML+= "<h3 style=\"padding: 0px; color: black\">" + result[p][1]["subtitle"]+ "</h3>";
                    document.getElementById("content_modify").innerHTML+= "<textarea name=\"intro_sub_content\" class=\"form-control\" rows = \" 30 \">" + result[p][1]["content"] + "</textarea><p>";

                    document.getElementById("content_modify").innerHTML+= "<h3 style=\"padding: 0px; color: black\">" + result[p][2]["subtitle"]+ "</h3>";
                    document.getElementById("content_modify").innerHTML+= "<textarea name=\"intro_sub_content\" class=\"form-control\" rows = \" 10 \">" + result[p][2]["content"] + "</textarea><p>";
                }
            }

			for(var p in result) {
                if (p == "c_and_c") {
                    document.getElementById("content_modify").innerHTML+= "<h2 style=\"padding: 0px; color: black\"> Imbalanced Data: Causes and Characteristics </h2>";
                    document.getElementById("content_modify").innerHTML+= "<textarea id=section_" + p + " class=\"form-control\" rows = \" 20 \" >" + result[p] + "</textarea>";
                }
            }

            for(var p in result) {
                if (p == "evaluation") {
                    document.getElementById("content_modify").innerHTML+= "<h2 style=\"padding: 0px; color: black\"> Evaluation Metrics for Imbalanced Data </h2>";
                    document.getElementById("content_modify").innerHTML+= "<textarea id=section_" + p + " class=\"form-control\" rows = \" 30 \" >" + result[p] + "</textarea>";
                }
            }

            for(var p in result) {
                if (p == "methodology") {
                    document.getElementById("content_modify").innerHTML+= "<h2 style=\"padding: 0px; color: black\"> Techniques for Handling Imbalanced Data </h2>";
                    document.getElementById("content_modify").innerHTML+= "<textarea id=section_" + p + " class=\"form-control\" rows = \" 10 \">" + result[p][0] + "</textarea><p>";

                    document.getElementById("content_modify").innerHTML+= "<h3 style=\"padding: 0px; color: black\"> Sub-section </h3>";
                    document.getElementById("content_modify").innerHTML+= "<textarea name=\"method_sub_title\" class=\"form-control\" rows = \" 1 \">" + result[p][1][0]["subtitle"] + "</textarea><p>";
                    document.getElementById("content_modify").innerHTML+= "<textarea name=\"method_sub_content\" class=\"form-control\" rows = \" 30 \">" + result[p][1][0]["content"] + "</textarea><p>";

                    document.getElementById("content_modify").innerHTML+= "<h3 style=\"padding: 0px; color: black\"> Sub-section </h3>";
                    document.getElementById("content_modify").innerHTML+= "<textarea name=\"method_sub_title\" class=\"form-control\" rows = \" 1 \">" + result[p][1][1]["subtitle"] + "</textarea><p>";
                    document.getElementById("content_modify").innerHTML+= "<textarea name=\"method_sub_content\" class=\"form-control\" rows = \" 10 \">" + result[p][1][1]["content"] + "</textarea><p>";

                    document.getElementById("content_modify").innerHTML+= "<h3 style=\"padding: 0px; color: black\"> Sub-section </h3>";
                    document.getElementById("content_modify").innerHTML+= "<textarea name=\"method_sub_title\" class=\"form-control\" rows = \" 1 \">" + result[p][1][2]["subtitle"] + "</textarea><p>";
                    document.getElementById("content_modify").innerHTML+= "<textarea name=\"method_sub_content\" class=\"form-control\" rows = \" 10 \">" + result[p][1][2]["content"] + "</textarea><p>";
                }
            }

			for(var p in result) {
                if (p == "app") {
                    document.getElementById("content_modify").innerHTML+= "<h2 style=\"padding: 0px; color: black\"> Applications of Predictive Modeling on Imbalanced Data </h2>";
                    document.getElementById("content_modify").innerHTML+= "<textarea id=section_" + p + " class=\"form-control\" rows = \" 20 \" >" + result[p] + "</textarea>";
                }
            }

            for(var p in result) {
                if (p == "clg") {
                    document.getElementById("content_modify").innerHTML+= "<h2 style=\"padding: 0px; color: black\"> Challenges and Open Issues </h2>";
                    document.getElementById("content_modify").innerHTML+= "<textarea id=section_" + p + " class=\"form-control\" rows = \" 30 \" >" + result[p] + "</textarea>";
                }
            }


            for(var p in result) {
                if (p == "conclusion") {
                    document.getElementById("content_modify").innerHTML+= "<h2 style=\"padding: 0px; color: black\">Conclusion and Future Directions (Future directions generated by ChatGPT) </h2>";
                    document.getElementById("content_modify").innerHTML+= "<textarea id=section_" + p + " class=\"form-control\" rows = \" 35 \" >" + result[p] + "</textarea>";
                }
            }




            for(var p in result) {
                if (p == "references") {
                    var cnt = 1;
                    for (var entry in result[p]) {
                        document.getElementById("references").innerHTML+= "<p style=\"color:black;\">[" + cnt + "]" + "   " + result[p][entry] + "</p>";
                        cnt = cnt + 1;
                    }
                }
            }

            $("#modification").attr("style","display:inline;");
        },
        error: function(jqXHR, textStatus, errorThrown){
            alert(jqXHR.responseText);
        }
    });

    }

	marked.setOptions({
            sanitize: true,
            // 可选：你还可以启用其他选项，如 smartypants
            smartypants: true
        });
		
	function display_survey() {
		// 防止重复点击
		if ($('#upload-progress').is(':visible')) {
			return; // 如果已经在生成中，直接返回
		}
		
		// 显示加载状态（使用与clustering和PDF下载一致的进度条）
		showUploadProgress();
		// 更新进度条标题和初始消息
		$('#upload-progress h4').text('Generating Survey...');
		updateProgressBar(0, 'Starting survey generation...');

		// 启动异步survey生成
		$.ajax({
			url: '/get_survey_id/', // ← 注意结尾的斜杠
			method: 'POST',
			dataType: 'json',
			success: function(data) {
				if (data.operation_id) {
					// 开始跟踪进度
					pollSurveyProgress(data.operation_id);
				} else {
					hideUploadProgress();
					alert("Failed to start survey generation.");
				}
			},
			error: function(jqXHR, textStatus, errorThrown) {
				hideUploadProgress();
				alert("Failed to start survey generation: " + jqXHR.responseText);
			}
		});
	}

	function pollSurveyProgress(operationId) {
		function checkProgress() {
			$.ajax({
				type: "GET",
				url: "/get_operation_progress/",
				data: { operation_id: operationId },
				success: function(result) {
					const progress = result.progress || 0;
					const message = result.message || "Processing...";
					const status = result.status || 'running';
					
					// 使用与其他功能一致的进度条更新函数
					updateProgressBar(progress, message);
					
					if (status === 'completed' || progress >= 100) {
						// 生成完成，加载survey内容
						setTimeout(() => {
							hideUploadProgress();
							loadSurveyContent(result.result ? result.result.survey_id : null);
						}, 500);
					} else if (status === 'failed' || progress < 0) {
						// 生成失败
						hideUploadProgress();
						alert("Survey generation failed: " + message);
					} else {
						// 继续轮询
						setTimeout(checkProgress, 2000);
					}
				},
				error: function(jqXHR, textStatus, errorThrown) {
					console.error('Survey progress check failed:', textStatus, errorThrown);
					// 继续尝试，但增加间隔
					setTimeout(checkProgress, 5000);
				}
			});
		}
		
		checkProgress();
	}

	function loadSurveyContent(survey_id) {
		if (!survey_id) {
			// 如果没有survey_id，尝试从全局变量获取
			$.ajax({
				url: '/get_surveys/',
				method: 'GET',
				dataType: 'json',
				success: function(data) {
					const surveys = data.surveys;
					if (surveys && surveys.length > 0) {
						survey_id = surveys[surveys.length - 1]; // 使用最新的survey
						loadSurveyContentWithId(survey_id);
					} else {
						alert("No survey ID found.");
					}
				},
				error: function() {
					alert("Failed to get survey ID.");
				}
			});
		} else {
			loadSurveyContentWithId(survey_id);
		}
	}

	function loadSurveyContentWithId(survey_id) {
		// 获取 JSON 文件内容
		$.ajax({
			url: '/static/data/txt/' + survey_id + '/generated_result.json',
			method: 'GET',
			dataType: 'json',
			success: function(surveyData) {
				console.log(surveyData);
				document.getElementById("survey_content").innerHTML = "";

				// 显示 Survey 标题
				var topic = document.getElementById("topic_input_box").value || "Default Topic";
				var surveyTitleMarkdown = "# A Survey of " + topic;
				var surveyTitleHTML = marked.parse(surveyTitleMarkdown);
				document.getElementById("survey_content").innerHTML += surveyTitleHTML;

				// 显示 Survey 内容
				var contentMarkdown = surveyData.content || "No content available.";
				var contentHTML = marked.parse(contentMarkdown);
				document.getElementById("survey_content").innerHTML += contentHTML;
				var turndownService = new TurndownService();
				$("#survey").attr("style", "display:inline;");
				
				// 绑定编辑功能
				$("#editBtn").off("click").on("click", function() {
					var currentHTML = document.getElementById("survey_content").innerHTML;
					var editorContainer = `<textarea id="richTextEditor">${currentHTML}</textarea>`;
					$("#survey_content").html(editorContainer);

					// 初始化 TinyMCE
					tinymce.init({
						selector: '#richTextEditor', // 绑定到指定的 textarea
						height: 400, // 编辑器高度
						menubar: false, // 是否显示菜单栏
						plugins: 'lists link image table code help', // 插件
						toolbar: 'undo redo | formatselect | bold italic | alignleft aligncenter alignright | bullist numlist | link image | code | help', // 工具栏
						image_title: true,
						/* enable automatic uploads of images represented by blob or data URIs*/
						automatic_uploads: true,
						/*
							URL of our upload handler (for more details check: https://www.tiny.cloud/docs/configure/file-image-upload/#images_upload_url)
							images_upload_url: 'postAcceptor.php',
							here we add custom filepicker only to Image dialog
						*/
						file_picker_types: 'image',
						/* and here's our custom image picker*/
						file_picker_callback: (cb, value, meta) => {
							const input = document.createElement('input');
							input.setAttribute('type', 'file');
							input.setAttribute('accept', 'image/*');

							input.addEventListener('change', (e) => {
							const file = e.target.files[0];

							const reader = new FileReader();
							reader.addEventListener('load', () => {
								/*
								Note: Now we need to register the blob in TinyMCEs image blob
								registry. In the next release this part hopefully won't be
								necessary, as we are looking to handle it internally.
								*/
								const id = 'blobid' + (new Date()).getTime();
								const blobCache =  tinymce.activeEditor.editorUpload.blobCache;
								const base64 = reader.result.split(',')[1];
								const blobInfo = blobCache.create(id, file, base64);
								blobCache.add(blobInfo);

								/* call the callback and populate the Title field with the file name */
								cb(blobInfo.blobUri(), { title: file.name });
							});
							reader.readAsDataURL(file);
							});

							input.click();
						},			  
					});

					$("#editBtn").hide();
					$("#saveBtn").show();
				});

				// 绑定保存功能
				$("#saveBtn").off("click").on("click", function() {
					var newHTML = tinymce.get('richTextEditor').getContent(); // 获取富文本编辑器的内容
					$("#survey_content").html(newHTML);
					tinymce.remove('#richTextEditor'); // 移除编辑器实例
					$("#editBtn").show();
					$("#saveBtn").hide();
				});     

				// 注意：PDF下载按钮已在文件末尾使用异步进度跟踪方式重新绑定
				// 这里不再重复绑定以避免冲突
			},
			error: function() {
				loadingOverlay.style.display = "none";
				alert("Failed to load survey content. The survey may still be generating.");
			}
		});
	}

	// 添加进度跟踪功能
	let currentOperationId = null;
	let progressInterval = null;

	function startProgressTracking(operationId, progressCallback) {
		currentOperationId = operationId;
		progressInterval = setInterval(() => {
			fetch(`/get_operation_progress/?operation_id=${operationId}`)
				.then(response => response.json())
				.then(data => {
					if (data.progress !== undefined) {
						progressCallback(data.progress, data.message);
						
						// 如果完成或失败，停止跟踪
						if (data.progress >= 100 || data.progress < 0) {
							stopProgressTracking();
						}
					}
				})
				.catch(error => {
					console.error('Progress tracking error:', error);
				});
		}, 2000); // 每2秒更新一次
	}

	function stopProgressTracking() {
		if (progressInterval) {
			clearInterval(progressInterval);
			progressInterval = null;
		}
		currentOperationId = null;
	}

	// --- PDF/LaTeX异步下载按钮逻辑 ---
	$('#downloadBtn').off('click').on('click', async function() {
		// 显示进度条（与其他功能一致）
		showUploadProgress();
		$('#upload-progress h4').text('Generating PDF...');
		updateProgressBar(0, 'Starting PDF generation...');
		
		try {
			// 获取survey内容并转换为Markdown
			var surveyContentHTML = document.getElementById("survey_content").innerHTML;
			var turndownService = new TurndownService();
			var markdownContent = turndownService.turndown(surveyContentHTML);
			
			// 创建FormData并添加内容
			var form = new FormData();
			form.append('content', markdownContent);
			
			// 尝试获取survey_id
			var topic = document.getElementById("topic_input_box").value || "Default Topic";
			if (typeof survey_id !== 'undefined') {
				form.append('survey_id', survey_id);
			}
			
			const response = await fetch('/generate_pdf/', {
				method: 'POST',
				body: form
			});
			if (!response.ok) {
				hideUploadProgress();
				return;
			}
			const result = await response.json();
			if (result.operation_id) {
				// 轮询进度
				await pollAsyncDownload(result.operation_id, 'pdf');
			} else {
				hideUploadProgress();
			}
		} catch (e) {
			hideUploadProgress();
			console.error('PDF generation error:', e);
		}
	});

	$('#finalDownloadBtn').off('click').on('click', async function() {
		// 显示进度条（与其他功能一致）
		showUploadProgress();
		$('#upload-progress h4').text('Generating LaTeX PDF...');
		updateProgressBar(0, 'Starting LaTeX PDF generation...');
		
		try {
			// 获取survey内容并转换为Markdown（与PDF生成一致）
			var surveyContentHTML = document.getElementById("survey_content").innerHTML;
			var turndownService = new TurndownService();
			var markdownContent = turndownService.turndown(surveyContentHTML);
			
			// 创建FormData并添加内容
			var form = new FormData();
			form.append('content', markdownContent);
			
			// 尝试获取survey_id
			var topic = document.getElementById("topic_input_box").value || "Default Topic";
			if (typeof survey_id !== 'undefined') {
				form.append('survey_id', survey_id);
			}
			
			const response = await fetch('/generate_pdf_from_tex/', {
				method: 'POST',
				body: form
			});
			if (!response.ok) {
				hideUploadProgress();
				return;
			}
			const result = await response.json();
			if (result.operation_id) {
				await pollAsyncDownload(result.operation_id, 'latex');
			} else {
				hideUploadProgress();
			}
		} catch (e) {
			hideUploadProgress();
			console.error('LaTeX PDF generation error:', e);
		}
	});

	async function pollAsyncDownload(operationId, type) {
		let status = 'running';
		let downloadUrl = '';
		while (status === 'running') {
			await new Promise(r => setTimeout(r, 2000));
			try {
				const res = await fetch(`/get_operation_progress/?operation_id=${operationId}`);
				const data = await res.json();
				status = data.status || 'running';
				
				// 更新进度条
				const progress = data.progress || 0;
				const message = data.message || 'Processing...';
				updateProgressBar(progress, message);
				
				if (status === 'completed') {
					// 后端应返回文件下载url或直接触发下载
					downloadUrl = (type === 'pdf')
						? `/static/data/results/survey_${data.result.survey_id}.pdf`
						: `/static/data/results/survey_${data.result.survey_id}_latex.pdf`;
					
					// 等待一下让用户看到100%完成
					updateProgressBar(100, 'PDF ready! Displaying in viewer...');
					await new Promise(r => setTimeout(r, 500));
					
					// 在iframe中显示PDF，而不是下载
					document.getElementById('pdf-preview-frame').src = downloadUrl;
					document.getElementById('pdf-preview-section').style.display = 'block';
					
					// 设置下载链接
					const downloadLink = document.getElementById('pdf-download-link');
					downloadLink.href = downloadUrl;
					downloadLink.style.display = 'inline-block';
					downloadLink.download = (type === 'pdf') 
						? `survey_${data.result.survey_id}.pdf`
						: `survey_${data.result.survey_id}_latex.pdf`;
					
					// 滚动到PDF预览区域
					document.getElementById('pdf-preview-section').scrollIntoView({ behavior: 'smooth' });
					
					break;
				} else if (status === 'failed') {
					alert('PDF generation failed: ' + (data.error || 'Unknown error'));
					break;
				}
			} catch (error) {
				console.error('Progress polling error:', error);
				// 继续尝试
			}
		}
		hideUploadProgress();
	}

</script>

	<!-- 测试异步功能区域
	<div class="container mt-4">
		<div class="card">
			<div class="card-header">
				<h5>测试异步功能</h5>
			</div>
			<div class="card-body">
				<button type="button" class="btn btn-primary" onclick="testAsyncFunction()">
					测试异步任务
				</button>
				<div id="test-result" class="mt-3"></div>
			</div>
		</div>
	</div>

	<script>
	function testAsyncFunction() {
		$('#test-result').html('<div class="alert alert-info">开始测试异步功能...</div>');
		
		$.ajax({
			type: "POST",
			url: "/test_async_simple/",
			success: function(result) {
				if (result.operation_id) {
					$('#test-result').html('<div class="alert alert-success">异步任务已启动，operation_id: ' + result.operation_id + '</div>');
					pollTestProgress(result.operation_id);
				} else {
					$('#test-result').html('<div class="alert alert-warning">响应格式异常: ' + JSON.stringify(result) + '</div>');
				}
			},
			error: function(jqXHR, textStatus, errorThrown) {
				$('#test-result').html('<div class="alert alert-danger">测试失败: ' + jqXHR.responseText + '</div>');
			}
		});
	}

	function pollTestProgress(operationId) {
		function checkProgress() {
			$.ajax({
				type: "GET",
				url: "/get_operation_progress/",
				data: { operation_id: operationId },
				success: function(result) {
					const progress = result.progress || 0;
					const message = result.message || 'Processing...';
					const status = result.status || 'running';

					$('#test-result').html(`
						<div class="alert alert-info">
							<strong>进度: ${progress}%</strong><br>
							状态: ${status}<br>
							消息: ${message}
						</div>
					`);

					if (status === 'completed') {
						$('#test-result').html(`
							<div class="alert alert-success">
								<strong>测试完成!</strong><br>
								结果: ${JSON.stringify(result.result)}
							</div>
						`);
					} else if (status === 'failed') {
						$('#test-result').html(`
							<div class="alert alert-danger">
								<strong>测试失败!</strong><br>
								错误: ${result.error || 'Unknown error'}
							</div>
						`);
					} else {
						setTimeout(checkProgress, 1000);
					}
				},
				error: function(jqXHR, textStatus, errorThrown) {
					$('#test-result').html(`
						<div class="alert alert-warning">
							进度查询失败: ${textStatus}<br>
							继续尝试...
						</div>
					`);
					setTimeout(checkProgress, 2000);
				}
			});
		}
		checkProgress();
	}
	</script> -->

{% endblock %}
{% endblock %}
<!--<script src="http://code.jquery.com/jquery-1.9.1.js"></script>-->
<!--<script src='../../../static/scripts/bootstrap.min.js' ></script>-->
<!--<script src='../../../static/scripts/jquery.nicescroll.min.js' ></script>-->
<!--<script src='../../../static/scripts/evenfly.js' ></script>-->

</body>

<footer>
	<p>
	<p>
	<p>
	<!--<h5 align="center" > IMCL NLP Group</h5>-->
</footer>
</html>

